(function(e,t){"use strict";function o(e,t){var n=e.url,i=e.method.toUpperCase(),u=e.headers||{},a=i==="GET"?e.data:e.query,f=JSON.stringify(e.data),l=[],c=new XMLHttpRequest;s.each(a,function(e,t){l.push(r(t)+"="+r(e))}),l.length&&(n+="?"+l.join("&")),c.open(i,n),c.setRequestHeader("Content-Type","application/json"),s.each(u,function(e,t){c.setRequestHeader(t,e)}),c.responseType="json",c.onreadystatechange=o.handleResponse(t),c.send(f)}function u(e){return this.events={},this.context=e||this,this}function a(e,t){return e=e||{},this.id=e.id||null,this.cid=s.guid(),this.destroyed=!1,this.attributes={},this.config=s.extend({},t),this.set(e),u.addTo(this),this}function f(e,t){return this.length=0,this.config=s.extend({Model:a},t),this.buildIndexes(),e&&this.add(e),u.addTo(this),this}function l(e,t){return a.call(this,e,t)}function c(e,t){return a.call(this,e,t)}function h(e,t){return t.Model=c,f.call(this,e,t)}function p(e,n){var r=this,i=this.constructor,s=i.UserModel,o=i.MessagesCollection,a={};r.app_id=e,r.api_token=n,r.initialized=!1,r.poll_timer=null,a.endpoint=r.endpoint("users"),a.api_token=n,r.user=new s(null,a),r.messages=r.createMessagesCollection(),u.addTo(r),r.user.on("sync",function(){r.initialized=!0}),r.messages.on("add",function(e,n){var i=e.get("type");i==="broadcast"?r.trigger("message:broadcast",e,n):i==="incoming"?r.trigger("message:incoming",e,n):i===t&&r.trigger("message:outgoing",e,n),r.trigger("message",e,n)})}var n=e.XMLHttpRequest,r=e.encodeURIComponent,i=e.supportive,s={each:function(e,t){if(!e)return e;if("length"in e){if(Array.prototype.forEach)return Array.prototype.forEach.call(e,t,e);for(var n=0;n<e.length;n++)t.call(e,e[n],n,e)}else for(var r in e)e.hasOwnProperty(r)&&t.call(e,e[r],r,e);return e},filter:function(e,t){var n=[];return Array.prototype.filter?Array.prototype.filter.call(e,t):(s.each(e,function(r,i){var s=t.call(e,r,i,e);s&&n.push(r)}),n)},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},isEqual:function(e,t){if(!e||!t)return!1;for(var n in e)if(t[n]!==e[n])return!1;for(var n in t)if(e[n]!==t[n])return!1;return!0},clone:function(e){return s.extend({},e)},bind:function(e,t){return function(){return t.apply(e,arguments)}},fire:function(t){var n=Array.prototype.slice.call(arguments,1);typeof t=="function"&&t.apply(e,n)},guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}};o.handleResponse=function(e){return function(){var t={};if(this.readyState!==4)return;if(typeof e!="function")return;this.status>300?(t.request=this,t.status=this.status,t.text=this.statusText,t.message=this.response,e(t,null)):e(null,this.response)}},u.addTo=function(e){var t=new this(e);return e.listeners=s.bind(t,t.listeners),e.trigger=s.bind(t,t.trigger),e.on=s.bind(t,t.on),e.once=s.bind(t,t.once),e.off=s.bind(t,t.off),e.proxy=s.bind(t,t.proxy),t},u.prototype={listeners:function(){return this.events},trigger:function(e){var t=this.context||this,n=this.events[e],r;if(!n)return;return r=Array.prototype.slice.call(arguments,1),s.each(n,function(e){e.apply(t,r)}),e!=="*"&&this.trigger("*",arguments),t},on:function(e,t){var n=this.events,r=n[e];if(typeof t!="function")throw new Error("An event handler must be passed.");return r||(r=n[e]=[]),r.push(t),this.context||this},once:function(e,t){function r(){t.apply(this,arguments),n.off(e,r)}var n=this;return this.on(e,r),this.context||this},off:function(e,t){var n=this.events,r=n[e];if(!e)return Boolean(this.events={});if(!r)return!1;if(t){for(var i=0;i<r.length;i++){var s=r[i];if(s===t)return r.splice(i,1),!0}return!1}return r.length=0,!0}},a.prototype={constructor:a,url:function(){var e=this.isNew(),t=this.config,n=t.collection?t.collection.url():t.endpoint;return e?n:n+(this.id||"")},isNew:function(){return!this.id},get:function(e){var t=this.attributes[e];return typeof t=="object"?s.clone(t):t},set:function(e,n){var r=this,i=!1,o={},u={};return r.destroyed?!1:(typeof e!="object"?o[e]=n:o=e,s.each(o,function(e,n){var s=r._set(n,e);if(s===t)return;i=!0,u[n]=s}),i&&r.trigger("change",r,u),i?u:!1)},_set:function(e,n){var r=this.attributes,i=r[e];return i===n?t:typeof n=="object"&&s.isEqual(n,i)?t:(e==="id"&&(this.id=n),r[e]=n,this.trigger("change:"+e,this,n,i),{old_value:i,new_value:n})},save:function(e,t){var n=this,r=n.isNew(),i=n.destroyed,o={};return i?s.fire(t,"Cannot save a model that has been deleted"):(typeof e=="function"?t=e:this.set(e),o.url=n.url(),o.method=r?"post":"put",o.data=n,n.sync(o,n.config,function(e,r){if(e)return s.fire(t,e);n.set(r),n.trigger("sync",this),s.fire(t,null,n)}),this)},fetch:function(e){var t=this,n=t.isNew(),r=t.destroyed,i={};return n?s.fire(e,"Cannot fetch a model that has no `id`."):r?s.fire(e,"Cannot fetch a model that has been deleted"):(i.url=t.url(),i.method="get",t.sync(i,t.config,function(e,n){if(e)return s.fire(n,e);t.set(attributes),this.trigger("sync",this),s.fire(n,null,t)}),this)},destroy:function(e){var t=this,n=t.isNew(),r=t.attributes,i={};return n?s.fire(e,"Cannot delete a model that has no `id`."):(i.url=t.url(),i.method="delete",i.data=t,t.sync(i,t.config,function(n){if(n)return s.fire(e,n);for(key in r)delete r[key];t.destroyed=!0,t.trigger("destroy",t),t.off(),s.fire(e,null,t)}),this)},toJSON:function(){return s.clone(this.attributes)},sync:function(e,t,n){o(e,n)}},f.prototype={constructor:f,length:0,splice:function(){var e=Array.prototype.splice.apply(this,arguments);return this.buildIndexes(),e},push:function(e){var t=Array.prototype.push.call(this,e);return this._addIndex(e,t-1),t},pop:function(){var e=Array.prototype.pop.call(this);return e&&this._removeIndex(e),e},each:function(e){return s.each(this,e)},filter:function(e){return s.filter(this,e)},buildIndexes:function(){return this.indexes={id_to_cid:{},cid_to_index:{}},this.each(function(e,t){this._addIndex(e,t)}),this},_addIndex:function(e,t){var n=this.indexes,r=e.id,i=e.cid,s=n.id_to_cid,o=n.cid_to_index;this._removeIndex(e),r&&(s[r]=i),o[i]=t},_removeIndex:function(e){var t=this.indexes,n=t.id_to_cid,r=t.cid_to_index;delete n[e.id],delete r[e.cid]},reset:function(e){this.length=0,this.buildIndexes(),e||this.trigger("reset",this)},url:function(){return this.config.endpoint},get:function(e){var t=this.indexOf(e);return this.at(t)||null},at:function(e){return this[e]||null},indexOf:function(e){var t=this.indexes,n=t.id_to_cid[e]||e,r=t.cid_to_index[n];return r>=0?r:-1},add:function(e){var t=this,n=[],r=!1;return e?("length"in e||(e=[e])&&(r=!0),s.each(e,function(e){var r=t._add(e);r&&n.push(r)}),s.each(n,function(e){var n=t.indexOf(e.cid);t.trigger("add",e,n,this)}),r?n[0]||!1:n):n},_add:function(e){var t=this.config.Model,n=e instanceof t,r=e.id||e.cid,i=this.get(r),o=s.extend({collection:this},this.config);return n?s.extend(e.config,o):e=new t(e,o),i?(i.set(e.attributes),this._insert(i),!1):(this._insert(e),this._proxyModel(e),e)},_insert:function(e){var t=this.comparator,n=this.indexOf(e.id||e.cid),r=n<0?this.length:n;return t?this._insertSort(e,r,t):this._push(e)-1},sort:function(e){e=e||this.comparator;if(!e)throw new Error("No comparator available to use for sort.");return this.each(function(t,n){this._insertSort(t,n,e)}),this},_insertSort:function(e,t,n){for(var r=t-1;r>=0;r--){var i=this[r];t-=!!n.call(this,e,i);if(t!==r)break;this[t]=i,t===this.length&&this.length++,this._addIndex(i,t)}return this[t]=e,t===this.length&&this.length++,this._addIndex(e,t),t},_proxyModel:function(e){var t=this;e.on("change",function(e,n){var r=t.indexes,i=n.id,s=t.indexOf(e.cid);i&&(t._addIndex(e,s),delete r.id_to_cid[i.old_value]),t.trigger("change",e,n,t)}),e.once("destroy",function(e){t.remove(e)})},remove:function(e){var t=this.indexOf(e),n=this.id,r;return t<0?!1:(r=this.splice(t,1)[0],this.trigger("remove",r,t,this),!0)},create:function(e,t){var n=this,r=n.add(e);return r.save(function(e,r){if(e)return s.fire(t,e);s.fire(t,null,r,n)}),r},fetch:function(e){var t=this,n={};return n.url=t.url(),n.method="get",t.sync(n,t.config,function(n,r){function f(){u++}var i={},o=0,u=0,a=0;if(n)return s.fire(e,n);t.each(function(e){var n;if(e.isNew())return;for(var i=0;i<r.length;i++){n=r[i];if(e.id===n.id)return}t.remove(e),a++}),t.on("change",f),o=t.add(r).length,t.off("change",f),i.has_changed=Boolean(o||u||a),i.added=o,i.updated=u,i.removed=a,t.trigger("sync",i,t),s.fire(e,null,i,t)}),this},sync:function(e,t,n){o(e,n)},toJSON:function(){var e=[],t=null;return this.forEach(function(t){e.push(t)}),e}},l.prototype=new a,l.prototype.constructor=l,l.prototype.setCustomData=function(e,t){var n=this.get("custom_data");return n[e]=t,this.set("custom_data",n)},c.prototype=new a,c.prototype.constructor=c,c.prototype.url=function(){var e=this.isNew(),t=this.config,n=t.user,r=t.collection,i=r?r.url():n.url()+i;return e?i:i+(this.id||"")},c.prototype.reply=function(e,t){var n=this.config,r=n.collection,i=new this.constructor(e,this.config);i.set("thread",this.get("thread")),i.set("subject",this.get("subject")),r&&r.add(i),i.save(t)},h.prototype=new f,h.prototype.constructor=h,h.prototype.url=function(){var e=this.config,t=e.endpoint,n=e.user;return n.url()+t},h.prototype.comparator=function(e,t){var n=Date.parse(e.get("created_at")),r=Date.parse(t.get("created_at"));return n<r},p.prototype={constructor:p,endpoint:function(e,t){var n=this.constructor,r=n.BASE_URL+this.app_id,i=n.ENDPOINTS[e];return t?i:r+i},init:function(e,t){var n=this;return n._setupUser(e),n.user.save(function(r){if(r)return s.fire(t,r);n.fetchMessages(function(r,i,o){if(r)return s.fire(t,r);n.listenForMessages(),s.fire(t,null,e,o,n)})}),n},createMessagesCollection:function(e){var t=this.constructor.MessagesCollection,n={};return n.user=this.user,n.endpoint=this.endpoint("messages",!0),n.api_token=this.api_token,new t(null,n)},createMessageModel:function(e){var t=this.constructor.message_model,n={};return n.user=this.user,n.endpoint=this.endpoint("messages",!0),n.api_token=api_token,new t(e,n)},send:function(e,t,n,r){var i={};return typeof t=="object"?(n=t)&(t=null):typeof t=="function"?(r=t)&(t=null):typeof n=="function"&&(r=n)&(n=null),this.initialized?(i={subject:e,text:t,custom_data:n},this.messages.create(i,r)):s.fire(r,"Cannot send message: user not initialized.")},fetchMessages:function(e){return this.initialized?(this.messages.fetch(e),this):s.fire(e,"Cannot fetch messages: user not initialized.")},listenForMessages:function(){var t=this.constructor.MESSAGE_POLL_INTERVAL,n=s.bind(this,this.fetchMessages);return this.initialized?this.poll_timer?!1:this.poll_timer=e.setInterval(n,t):s.fire(done,"Cannot poll for messages: user not initialized.")},stopListeningForMessages:function(){return e.clearInterval(this.poll_timer),this.poll_timer=null},_setupUser:function(e){if(!e.identifier)throw new Error("A user requires an identifier.");this.user.set(e)}},p.MESSAGE_POLL_INTERVAL=6e4,p.BASE_URL="https://api.supportive.io/apps/",p.ENDPOINTS={users:"/users/",messages:"/messages/"},p.sync=function(e,t,n){var r=e.headers=e.headers||{};t.api_token&&(r.Authorization="Bearer "+t.api_token),o(e,n)},p.noConflict=function(){return e.supportive=i,this},p.Events=u,p.Model=a,p.Collection=f,p.UserModel=l,p.MessageModel=c,p.MessagesCollection=h,l.prototype.sync=p.sync,c.prototype.sync=p.sync,h.prototype.sync=p.sync,typeof define=="function"?define(p):typeof module!="undefined"?module.exports=p:e.Supportive=p})(window)